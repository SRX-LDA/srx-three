import{Vector3 as e,Box3 as t,OrthographicCamera as n,MathUtils as s,BufferGeometry as i,BufferAttribute as r,MeshBasicMaterial as o,CustomBlending as a,SrcAlphaFactor as h,ZeroFactor as c,AddEquation as l,Scene as d,Mesh as m,Raycaster as u,Vector2 as g,GridHelper as p,ArrowHelper as f,AxesHelper as w,PerspectiveCamera as v,AmbientLight as x,DirectionalLight as b,CylinderGeometry as y,BoxGeometry as M,MeshPhongMaterial as S,Sphere as R,LoadingManager as j,WebGLRenderer as C,CullFaceFront as z,Clock as F,PMREMGenerator as E,TextureLoader as P,LinearToneMapping as L,ReinhardToneMapping as A,CineonToneMapping as k,ACESFilmicToneMapping as D,EquirectangularReflectionMapping as _,AnimationMixer as T}from"three";import{RoomEnvironment as q}from"three/examples/jsm/environments/RoomEnvironment.js";import{DebugEnvironment as O}from"three/examples/jsm/environments/DebugEnvironment.js";import{RGBELoader as B}from"three/examples/jsm/loaders/RGBELoader.js";import{OrbitControls as I}from"three/examples/jsm/controls/OrbitControls.js";function W(){return window.navigator.userAgent.toLowerCase().includes("mobile")}function G(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function X(t){const n=t.min,s=t.max;return[new e(n.x,n.y,n.z),new e(s.x,n.y,n.z),new e(n.x,s.y,n.z),new e(s.x,s.y,n.z),new e(n.x,n.y,s.z),new e(s.x,n.y,s.z),new e(n.x,s.y,s.z),new e(s.x,s.y,s.z)]}function H(t){const n=t.min,s=t.max;return[new e(n.x,0,0),new e(s.x,0,0),new e(0,n.y,0),new e(0,s.y,0),new e(0,0,n.z),new e(0,0,s.z)]}function V(e,t){return t.updateMatrixWorld(),t.updateProjectionMatrix(),e.map((e=>{const n=e.clone();return n.project(t),n}))}function Z(e){var n=new t;return n.makeEmpty(),e.forEach((e=>{n.expandByPoint(e)})),n}function K(e,t){e.left=-1,e.right=1,e.top=1,e.bottom=-1,e.near=-1,e.far=1,e.updateProjectionMatrix();var n=X(t),s=Z(n=V(n,e));e.left=s.min.x,e.right=s.max.x,e.top=s.max.y,e.bottom=s.min.y,e.near=s.min.z,e.far=s.max.z,e.updateProjectionMatrix()}function Y(t,i,r=1){var o=i.getCenter(new e),a=new n;a.position.copy(t.position),a.lookAt(o),a.updateMatrixWorld(),a.updateProjectionMatrix(),t.lookAt(o),t.updateMatrixWorld(),t.updateProjectionMatrix();var h=Z(V(X(i),a)).getSize(new e),c=h.y/2/Math.tan(s.degToRad(t.fov/2)),l=h.x/2/Math.tan(s.degToRad(t.fov*t.aspect/2)),d=Math.max(c,l);d*=r;var m=new e(0,0,1).applyQuaternion(t.quaternion);return t.position.copy(o).add(m.multiplyScalar(d)),t.updateProjectionMatrix(),{distance:d}}function J(e){return e.min.x!==1/0&&e.max.x!==-1/0}function Q(e){let n=new t;for(let t of e)if(t.updateMatrix(),t.updateMatrixWorld(!0),t.children&&t.children.length>0){let e=Q(t.children).clone();n.union(e)}else if(t.isMesh&&void 0!==t.geometry){t.geometry.computeBoundingBox();let e=t.geometry.boundingBox.clone();e.applyMatrix4(t.matrixWorld),n.union(e)}return n}function $(e,t=e=>!0){var n=[];return e.traverse((e=>{t(e)&&n.push(e)})),Q(n)}function N(e){var t,n,s=$(e,(e=>e.isMesh&&void 0!==e.geometry&&(e.receiveShadow||e.castShadow))),i=[];void 0!==e.traverse&&e.traverse((e=>{e.isLight&&e.castShadow&&void 0!==e.shadow&&i.push(e)}));for(let e of i)e.shadow.bias=1.5*(t=e.shadow.camera,n=e.shadow.mapSize.width,-(t.far-t.near)/(n*n)),K(e.shadow.camera,s)}function U(e,t){e.traverse((e=>{e.isLight&&e.castShadow&&(e.shadow.mapSize.width=t,e.shadow.mapSize.height=t)}))}function ee(){const e=new i,t=new Float32Array([-1,-1,0,1,1,0,1,-1,0,1,1,0,-1,-1,0,-1,1,0]),n=new Float32Array([0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0]);return e.setAttribute("position",new r(t,3)),e.setAttribute("color",new r(n,4)),e}function te(e,t){try{var n=t.split(",").map((e=>parseFloat(e.trim())));1==n.length?e.set(n[0],n[0],n[0]):3==n.length?e.set(n[0],n[1],n[2]):console.log("Cannot set Vector, expecting 1 or 3 values: "+t)}catch(n){console.log("Cannot parse Vector: "+t),e.set(0,0,0)}}class ne{left;right;top;bottom;scene;constructor(e={left:0,right:0,top:0,bottom:0}){const t=ee(),n=new o({vertexColors:!0});n.transparent=!0,n.blending=a,n.blendDst=h,n.blendSrc=c,n.blendEquation=l;const s=new d;this.left=new m(t,n),s.add(this.left),this.right=new m(t,n),this.right.rotation.z=Math.PI,s.add(this.right),this.bottom=new m(t,n),this.bottom.rotation.z=-Math.PI/2,s.add(this.bottom),this.top=new m(t,n),this.top.rotation.z=Math.PI/2,s.add(this.top),this.resize(e),this.scene=s}resize(e={left:0,right:0,top:0,bottom:0}){this.left.position.set(-1+e.left,0,0),this.left.scale.set(e.left,1,1),this.right.position.set(1-e.right,0,0),this.right.scale.set(e.right,1,1),this.bottom.position.set(0,1-e.bottom,0),this.bottom.scale.set(e.bottom,1,1),this.top.position.set(0,-1+e.top,0),this.top.scale.set(e.top,1,1)}}function se(e,t){var n;return e.traverse((e=>{e instanceof m&&e.name===t&&(n=e)})),n}function ie(){document.querySelectorAll(".three-scene").forEach((e=>{e.srxThree.isDisableRendering=!0}))}function re(){document.querySelectorAll(".three-scene").forEach((e=>{e.srxThree.isDisableRendering=!1}))}function oe(e){e.requestFullscreen?e.requestFullscreen():elem.webkitRequestFullscreen?e.webkitRequestFullscreen():elem.msRequestFullscreen&&e.msRequestFullscreen()}function ae(){null!==document.fullscreenElement&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}function he(e){e.traverse((e=>{e instanceof m&&(console.log(`Mesh '${e.name}':`),console.log(e))}))}function ce(t,n){te(t.position,n.position);var s=n.scale;t.scale.set(s,s,s);var i=new e(0,0,0);te(i,n.rotation),t.rotation.set(i.x*Math.PI/180,i.y*Math.PI/180,i.z*Math.PI/180),t.updateMatrix(),t.updateMatrixWorld(!0)}function le(t,n){var s=new e(0,0,0);te(s,n.position);var i=new e(0,0,0);te(i,n.rotation);var r=n.scale;t.position.add(s),t.scale.multiplyScalar(r),t.rotateY(i.x*Math.PI/180),t.rotateX(i.y*Math.PI/180),t.rotateZ(i.z*Math.PI/180),t.updateMatrix(),t.updateMatrixWorld(!0)}function de(e,t,n){var s=new I(e,t.domElement);return t.domElement.addEventListener("pointerleave",(e=>{t.domElement.dispatchEvent(new MouseEvent("pointerup"))})),s.target.set(0,0,0),n.limitAzimuthAngle&&(s.minAzimuthAngle=Math.PI/180*n.minAzimuthAngle,s.maxAzimuthAngle=Math.PI/180*n.maxAzimuthAngle),s.maxDistance=n.maxDistance,s.minDistance=n.minDistance,s.minPolarAngle=Math.PI/180*n.minPolarAngle,s.maxPolarAngle=Math.PI/180*n.maxPolarAngle,s.autoRotate=n.autoRotate,s.autoRotateSpeed=n.autoRotateSpeed,s.enablePan=n.enablePan,s.panSpeed=n.panSpeed,s.enableZoom=n.enableZoom,s.zoomSpeed=n.zoomSpeed,s.enableRotate=n.enableRotate,s.rotateSpeed=n.rotateSpeed,s.enableDamping=n.enableDamping,s.dampingFactor=n.dampingFactor,te(s.target,n.target),s.update(),s}function me(e,t,n,s,i){var r=new u,o=new g,a=n.getBoundingClientRect();return o.x=(e-a.left)/a.width*2-1,o.y=-(t-a.top)/a.height*2+1,r.setFromCamera(o,i),r.intersectObjects(s,!0)}function ue(t){var n=new p(10,10);t.add(n),t.add(new f(new e(1,0,0),new e(0,0,0),5,16711680)),t.add(new f(new e(0,1,0),new e(0,0,0),5,65280)),t.add(new f(new e(0,0,1),new e(0,0,0),5,255));var s=new w(5);t.add(s)}function ge(e){var t=new v(e.fov,1,e.near,e.far);return te(t.position,e.position),t}function pe(e){return"ambient"==e.light.type?new x(e.light.color.color,e.light.intensity):"directional"==e.light.type?(te((t=new b(e.light.color.color,e.light.intensity)).position,e.transform.position),t.castShadow=!0,t):"point"==e.light.type?(te((t=new PointLight(e.light.color.color,e.light.intensity,40,2)).position,e.transform.position),t):void 0;var t}function fe(e,t,n){if("studio_1"==n.scene){const e=new b(16777215,3);e.position.set(2,3,4),e.castShadow=!0,t.add(e);const n=new b(16448255,1.3);n.position.set(-4,2,-1),n.castShadow=!0,t.add(n);const s=new b(16775930,1);s.position.set(2,1,-3),s.castShadow=!1,t.add(s);const i=new x(3158064);i.castShadow=!1,t.add(i)}else if("studio_2"==n.scene){const e=new b(16777215,.9);e.position.set(2,3,2),e.castShadow=!0,t.add(e);const n=new b(16777164,.8);n.position.set(-4,2,-1),n.castShadow=!0,t.add(n);const s=new b(16764108,.4);s.position.set(-6,-3,1),t.add(s);const i=new x(1052688);i.castShadow=!1,t.add(i)}}async function we(e,t,n,s){let i=await import("three/examples/jsm/loaders/GLTFLoader.js"),r=await import("three/examples/jsm/loaders/DRACOLoader.js"),o=await import("three/examples/jsm/loaders/KTX2Loader.js"),a=await import("three/examples/jsm/libs/meshopt_decoder.module.js");const h=(new o.KTX2Loader).setTranscoderPath("examples/jsm/libs/basis/").detectSupport(n),c=new r.DRACOLoader(t);c.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.4.1/");const l=new i.GLTFLoader(t);l.setKTX2Loader(h),l.setMeshoptDecoder(a.MeshoptDecoder),l.setDRACOLoader(c),l.load(e,s,(e=>{}),(async e=>console.error(e)))}function ve(e,t){var n={linear:L,reinhard:A,cineon:k,aces_filmic:D};n[t.type]&&(e.toneMapping=n[t.type]),e.toneMappingExposure=t.exposure}function xe(e){var t;return t="round"==e.shape||"oval"==e.shape?new y(.5,.5,e.height,64):new M(1,e.height,1),new m(t,new S({color:e.color.color,specular:279620}))}function be(e){var t=new R;return e.updateMatrixWorld(),e.traverse((function(e){if(void 0!==e.geometry){e.geometry.computeBoundingSphere();let n=e.geometry.boundingSphere.clone();n.applyMatrix4(e.matrixWorld),t.union(n)}})),t}class ye{target;renderTarget;cfg;clock;loadManager;renderer;isChanged=!1;isDisableRendering=!1;isRendering=!1;isRequestingFrame=!1;isDebug=!1;isFullscreen=!1;isMobile=window.navigator.userAgent.toLowerCase().includes("mobile");cameraControls;composer;mixers=[];scene;camera;objects=[];sceneBoundingShere;ground;mask;pixelRatio=window.devicePixelRatio;fullscreenPixelRatio=this.pixelRatio;constructor(e,t){this.target=e,e.srxThree=this,this.cfg=t,this.init()}init(){if(this.renderTarget=this.target.querySelector(".three-target"),this.loadManager=new j,this.loadManager.onStart=(e,t,n)=>{this.showLoader()},this.loadManager.onLoad=()=>{this.hideLoader()},this.isMobile&&(this.pixelRatio=Math.max(1,this.pixelRatio/2),this.fullscreenPixelRatio=1),this.renderer=new C({antialias:!0,alpha:!0}),this.renderer.autoClear=!0,this.renderer.setPixelRatio(this.pixelRatio),this.renderTarget.appendChild(this.renderer.domElement),ve(this.renderer,this.cfg.styles.tone_mapping),this.scene=new d,"true"==this.target.getAttribute("data-debug")&&(this.isDebug=!0,ue(this.scene)),this.camera=ge(this.cfg.camera.settings),"orbit"==this.cfg.camera.control_type){var e=e=>{var t=this.isFullscreen||!this.cfg.camera.orbit.hitSceneObjcts;t||(t=me(e.clientX,e.clientY,this.renderer.domElement,this.objects,this.camera).length>0);this.cameraControls.enabled=t,this.cameraControls.enabled?e.preventDefault():e.stopPropagation()};this.renderer.domElement.addEventListener("pointerdown",e),this.cfg.camera.orbit.enableZoom&&this.renderer.domElement.addEventListener("wheel",e),this.renderer.domElement.addEventListener("touchstart",(e=>{this.cameraControls.enabled&&e.preventDefault()})),this.cameraControls=de(this.camera,this.renderer,this.cfg.camera.orbit),this.cameraControls.enabled=!1,this.renderer.domElement.style.touchAction="unset",this.cameraControls.addEventListener("change",(()=>this.isChanged=!0))}"none"!==this.cfg.scene.ground.shape&&(this.ground=xe(this.cfg.scene.ground),this.ground.position.y=-.5*this.cfg.scene.ground.height,this.ground.receiveShadow=!0,this.ground.visible=this.isDebug,this.scene.add(this.ground)),this.updateSize();new ResizeObserver((e=>{this.updateSize()})).observe(this.renderTarget);new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?this.startRender():this.stopRender()}))})).observe(this.renderTarget),this.hideLoader();var t=this.cfg.styles.background.alpahMask;(t.left||t.right||t.top||t.bottom)&&(this.mask={scene:new ne({left:t.left/100,right:t.right/100,top:t.top/100,bottom:t.bottom/100}),camera:new n(-1,1,-1,1,-10,10)}),this.setupEnvironment(this.cfg.environment),this.setupScene(this.cfg.scene),fe(this.renderer,this.scene,this.cfg.environment.lighting),U(this.scene,this.cfg.settings.shadow_resolution),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMapCullFace=z,this.setupControlButtons(),this.clock=new F,G(this.renderTarget)?this.startRender():this.animate()}setupControlButtons(){var e=this.target.querySelector(".controls .fullscreen");e&&!this.isDebug&&e.addEventListener("click",(()=>{this.isFullscreen?this.leaveFullscreen():this.enterFullscreen()})),this.target.addEventListener("fullscreenchange",(e=>{this.isFullscreen=null!=document.fullscreenElement,this.isFullscreen||this.leaveFullscreen()}))}enterFullscreen(){this.target.classList.add("isFullscreen"),this.isFullscreen=!0,this.renderer.setPixelRatio(this.fullscreenPixelRatio),"environment"==this.cfg.styles.fullscreen.background.background_type?this.scene.background=this.scene.environment:this.scene.background=null,ie(),this.isDisableRendering=!1,oe(this.target),this.updateSize()}leaveFullscreen(){this.isFullscreen=!1,this.target.classList.remove("isFullscreen"),this.renderer.setPixelRatio(this.pixelRatio),"environment"==this.cfg.styles.background.background_type?this.scene.background=this.scene.environment:this.scene.background=null,re(),ae(),this.updateSize()}updateSize(){var e=this.renderTarget.clientWidth,t=this.renderTarget.clientHeight;this.renderer.setSize(e,t),this.composer&&this.composer.setSize(e,t),this.camera.aspect=e/t,this.camera.fov=this.cfg.camera.settings.fov/(this.camera.aspect<1?this.camera.aspect:1),this.isChanged=!0,this.isFullscreen?this.camera.clearViewOffset():this.camera.setViewOffset(e,t,e*-this.cfg.camera.settings.view_offset_x/100,t*this.cfg.camera.settings.view_offset_y/100,e,t),this.render()}startRender(){this.isRendering||(this.isRendering=!0,this.animate())}stopRender(){this.isRendering=!1}animate(){const e=this.clock.getDelta();for(var t of this.mixers)t.update(e)&&(this.isChanged=!0);this.cameraControls&&this.objects.length>0&&this.cameraControls.update()&&(this.isChanged=!0),this.camera.updateProjectionMatrix(),this.isChanged&&(this.render(),this.isChanged=!1),this.isRendering&&!this.isRequestingFrame&&(this.isRequestingFrame=!0,requestAnimationFrame((()=>{this.isRequestingFrame=!1,this.animate()})))}render(){this.isDisableRendering||(this.sceneBoundingShere&&(this.camera.far=this.camera.position.distanceTo(this.sceneBoundingShere.center)+2*this.sceneBoundingShere.radius,this.camera.near=this.camera.far/1024,this.camera.updateProjectionMatrix()),this.renderer.render(this.scene,this.camera),this.mask&&!this.isFullscreen&&(this.renderer.autoClear=!1,this.renderer.clearDepth(),this.renderer.render(this.mask.scene.scene,this.mask.camera),this.renderer.autoClear=!0))}hideLoader(){this.target.querySelector(".loader").classList.add("hidden")}showLoader(){this.target.querySelector(".loader").classList.remove("hidden")}addObject(t,n){if(this.scene.add(t),null==n.type||"mesh"==n.type){if(this.objects.push(t),void 0!==t.traverse&&t.traverse((e=>{e.castShadow=n.settings.cast_shadow,e.receiveShadow=n.settings.receive_shadow})),le(t,n.transform),"auto"==n.transform.scale_mode){t.scale.set(1,1,1);var s=(o=Q([t])).getSize(new e),i=Math.min(s.x,s.y,s.z);let n=Math.floor(Math.log(i)/Math.log(10));var r=Math.pow(10,-n);1!=r&&(this.info("Autoscaled object by factor '"+r+"'"),t.scale.set(r,r,r))}if(t.updateMatrix(),"center_on_ground"==n.transform.position_mode){t.position.set(0,0,0);var o,a=(o=Q([t])).getCenter(new e);t.position.set(-a.x,-o.min.y,-a.z)}t.updateMatrix(),this.updateScene()}this.render(),this.isChanged=!0}updateScene(){this.sceneBoundingShere=be(this.scene);var t=Q(this.objects),n=t.getCenter(new e);if(this.ground){this.ground.visible=!0;var s=this.cfg.scene.ground;this.ground.position.set(n.x,t.min.y-.5*s.height,n.z),this.ground.scale.x=t.max.x-t.min.x+s.overlap,this.ground.scale.z=t.max.z-t.min.z+s.overlap,"round"==this.cfg.scene.ground.shape&&(this.ground.scale.x=this.ground.scale.z=Math.max(this.ground.scale.x,this.ground.scale.z)),this.ground.visible=!0}if(N(this.scene),"relative_to_scene_center"==this.cfg.camera.orbit.targetMode&&this.cameraControls&&void 0!==this.cameraControls.target&&this.cameraControls.target.add(n),"relative_to_scene_center"==this.cfg.camera.settings.position_mode&&this.camera.position.add(n),"auto"==this.cfg.camera.orbit.distanceMode){this.cameraControls.update();var i=Y(this.camera,t,this.cfg.camera.orbit.autoDistanceFactor/100);i&&(this.cameraControls.minDistance=.5*i.distance,this.cameraControls.maxDistance=2*i.distance,this.cameraControls.update())}}setupScene(e){if(Array.isArray(e.object))for(let t of e.object)this.setupObject(t);else this.setupObject(e.object)}setupObject(e){"light"==e.type&&this.addObject(pe(e),e),null!=e.type&&"mesh"!=e.type||this.setupMesh(e,(t=>{if(void 0===t)return this.error("Failed to load object. Check console for details."),void console.log(e);this.addObject(t,e)}))}setEnvironment(e){this.scene.environment=e,"environment"==this.cfg.styles.background.background_type&&(this.scene.background=this.scene.environment)}setupEnvironment(e){var t=null;if("file"==e.texture.source)t=e.texture.file.href;else if("examples"==e.texture.source){var n=e.texture.example;if("room"==n){const t=new E(this.renderer);this.setEnvironment(t.fromScene(new q,e.blurr).texture)}else if("debug"==n){const t=new E(this.renderer);this.setEnvironment(t.fromScene(new O,e.blurr).texture)}else t="https://threejs.org/"+n}let s=e=>{e.mapping=_,this.setEnvironment(e),this.isChanged=!0};null!=t&&(t.endsWith(".hdr")?new B(this.loadManager).load(t,s):new P(this.loadManager).load(t,s))}setupMesh(e,t){let n=this;function s(e){if(e.animations&&e.animations.length>0&&e.scene){var s=new T(e.scene);s.clipAction(e.animations[0]).play(),s.update(0),n.mixers.push(s)}e.scene?t(e.scene):t(e,object.settings)}if("box"==e.mesh.source)t(new m(new M,new S({color:16777215})));else if("example"==e.mesh.source)"teapot"==e.mesh.example?import("three/examples/jsm/geometries/TeapotGeometry.js").then((e=>{let n=new e.TeapotGeometry;n.scale(.02,.02,.02),t(new m(n,new S({color:16777215,shininess:100,specular:4473924,reflectivity:.5})))})):(e.mesh.example.endsWith(".glb")||e.mesh.example.endsWith(".gltf"))&&we("https://threejs.org/"+e.mesh.example,this.loadManager,this.renderer,s);else if("url"==e.mesh.source){var i=e.mesh.url.href.split(".").pop().toLowerCase();"glb"==i||"gltf"==i?we(e.mesh.url.href,this.loadManager,this.renderer,s):"obj"==i&&loadModelOBJ(e.mesh.url.href,this.loadManager,t)}}log(e,t){var n=this.target.querySelector(".srx-three-editor .log");n&&(n.innerHTML+="<div class='msg "+e+"'>"+t+"</div>")}info(e){this.log("info",e),console.log(e)}warn(e){this.log("warn",e),console.warn(e)}error(e){this.log("error",e),console.error(e)}}export{ne as MaskScene,ye as SrxThree,K as adjustOrthographicCamera,Y as adjustProcetionCameraDistance,ee as buildMaskGeometry,Z as calculateBoundingBoxFromPoints,ie as disableAllRendering,re as enableAllRendering,ae as exitFullscreen,se as findMeshInScene,me as findMouseEventObjects,Q as getBoundingBoxFromObjects,$ as getBoundingBoxFromScene,X as getCornersOfBoundingBox,be as getSceneBoundingSphere,H as getSideCentersOfBoundingBox,G as isElementVisible,W as isMobile,J as isValidBoundingBox,we as loadModelGLTF,oe as openFullscreen,he as printScene,V as projectVectorsToCamera,U as setShadowLightDetails,ce as setTransformFromFields,te as setVectorFromString,ge as setupCamera,xe as setupGround,ue as setupHelpers,pe as setupLight,fe as setupLighting,de as setupOrbitControls,ve as setupToneMapping,le as transformFromFields,N as updateShadowLightAreas};
//# sourceMappingURL=srx-three.js.map
